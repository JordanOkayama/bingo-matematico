<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bingo Matem√°tico</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0b0f14; --glass: rgba(255,255,255,.06); --stroke: rgba(255,255,255,.10);
  --text:#e7ecf2; --muted:#a8b3c5;
  --primaryA:#8a63ff; --primaryB:#19d3da; --success:#2ed573; --danger:#ff6b81;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --marked-bg: linear-gradient(135deg, rgba(46,213,115,0.18), rgba(25,211,120,0.12));
  --marked-color: #062017;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:
  radial-gradient(1200px 700px at 15% 10%, #12202f 0%, #0b0f14 50%),
  radial-gradient(1000px 600px at 95% 90%, #1a1028 0%, #0b0f14 60%);
  color:var(--text); font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial; min-height:100%}
.wrap{max-width:1200px;margin:36px auto;padding:0 16px}
.glass{background:var(--glass);border:1px solid var(--stroke);backdrop-filter: blur(12px) saturate(120%);
  -webkit-backdrop-filter: blur(12px) saturate(120%);border-radius:16px;box-shadow:var(--shadow)}
/* HERO */
header.hero{padding:18px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:46px;height:46px;border-radius:12px;background:conic-gradient(from 120deg,#7c4dff,#19d3da,#7c4dff);box-shadow:0 8px 26px rgba(138,99,255,.28)}
.brand h1{margin:0;font-size:1.25rem}
.hero-actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{padding:10px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:800;color:#071019;
  background: linear-gradient(135deg,var(--primaryA),var(--primaryB));box-shadow:0 10px 28px rgba(138,99,255,.18);transition:transform .12s}
.btn:hover{transform:translateY(-2px)}
.btn.ghost{background:transparent;color:var(--text);border:1px solid var(--stroke);box-shadow:none}
.btn.success{background:linear-gradient(135deg,var(--success),#19d3da);color:#071019}
.btn.danger{background:linear-gradient(135deg,#ff6b81,#ff9a9e);color:#071019}

.section{margin-top:18px;padding:18px}
.section h2{margin:0 0 6px 0;font-size:1.1rem}
.section .hint{color:var(--muted);font-size:.92rem;margin:0 0 12px}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:900px){.grid-2{grid-template-columns:1fr}}

label{display:block;font-weight:700;margin:6px 0 6px 2px;color:var(--text)}
input[type=number], select, input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text)}
.kpi{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px dashed var(--stroke);background:rgba(255,255,255,.02);color:var(--muted)}
.sep{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);margin:12px 0}
.expression{font-size:1.5rem;font-weight:900;margin:8px 0;color:#f7f8ff;text-shadow:0 3px 18px rgba(138,99,255,.18)}
.history{max-height:260px;overflow:auto;padding:10px;border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.02)}
.history .item{padding:8px;border-bottom:1px dashed var(--stroke);font-weight:700}
.cards-wrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
.card{padding:10px;border-radius:10px;border:1px solid var(--stroke);background: rgba(255,255,255,.03)}
.ticket-grid{display:grid;gap:6px}
.ticket-grid[data-size="3"]{grid-template-columns:repeat(3,1fr)}
.ticket-grid[data-size="5"]{grid-template-columns:repeat(5,1fr)}
.ticket-grid[data-size="7"]{grid-template-columns:repeat(7,1fr)}
.cell{border-radius:8px;padding:6px;text-align:center;font-weight:900;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.04);font-size:1.05rem;transition:transform .08s, background .12s, color .12s}
.cell.marked{background: var(--marked-bg); color: var(--marked-color); transform: translateY(-2px); box-shadow: 0 6px 18px rgba(46,213,115,.08); }
.alert{padding:8px;border-radius:8px;margin-top:10px}
.alert.warn{background:rgba(255,209,102,.06);border:1px solid rgba(255,209,102,.22);color:#ffe39b}
.alert.danger{background:rgba(255,109,120,.06);border:1px solid rgba(255,109,120,.22);color:#ffc2c7}
.alert.success{background:rgba(46,213,115,.06);border:1px solid rgba(46,213,115,.22);color:#b9ffcf}
.tiny{font-size:.86rem;color:var(--muted)}
.muted{color:var(--muted)}
.switch{display:inline-flex;align-items:center;gap:8px}
.toggle{width:46px;height:26px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--stroke);position:relative}
.dot{position:absolute;top:50%;left:4px;transform:translateY(-50%);width:18px;height:18px;border-radius:50%;background:#fff;transition:left .12s}
.switch input{display:none}
.switch input:checked + .toggle .dot{left:24px}
footer{color:var(--muted);text-align:center;margin:18px 0;font-size:.9rem}
.screen{display:none}
.screen.active{display:block}
.small-ghost{padding:8px 10px;border-radius:10px;background:transparent;border:1px solid var(--stroke);color:var(--text);cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <header class="hero glass">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Bingo Matem√°tico</h1>
        <div class="tiny muted">Tema glass/dark ‚Äî interface moderna</div>
      </div>
    </div>

    <div class="hero-actions">
      <button class="small-ghost" onclick="saveState()">üíæ Salvar estado</button>
      <button class="small-ghost" onclick="loadState()">üìÅ Carregar estado</button>
      <button class="small-ghost" onclick="clearState()">üßπ Limpar estado</button>
      <button class="btn" data-target="generate">Gerar cartela</button>
      <button class="btn success" data-target="config">Come√ßar sorteio</button>
      <button class="btn ghost" data-target="home">In√≠cio</button>
    </div>
  </header>

  <!-- HOME -->
  <section id="home" class="screen active section glass">
    <h2>Pronto para jogar?</h2>
    <p class="hint">Gere cartelas para a turma e/ou configure o sorteio. Voc√™ pode sortear sem cartelas ‚Äî ideal para reaproveitar impress√µes.</p>

    <div class="grid-2">
      <div class="card">
        <h3>Gerar cartelas</h3>
        <p class="tiny">Crie cartelas 3√ó3, 5√ó5 ou 7√ó7 e exporte em PDF (4 por p√°gina, paisagem).</p>
        <div class="sep"></div>
        <button class="btn" data-target="generate">Abrir gerador</button>
      </div>

      <div class="card">
        <h3>Configurar sorteio</h3>
        <p class="tiny">Escolha opera√ß√µes, dificuldade, intervalos e timers. Resultado das express√µes fica oculto at√© revelar.</p>
        <div class="sep"></div>
        <button class="btn success" data-target="config">Abrir configura√ß√µes</button>
      </div>
    </div>
  </section>

  <!-- GERA√á√ÉO CARTELAS -->
  <section id="generate" class="screen section glass">
    <h2>Gerador de cartelas</h2>
    <p class="hint">N√∫meros √∫nicos por cartela ‚Äî valida√ß√£o autom√°tica evita intervalo insuficiente.</p>

    <div class="grid-2">
      <div class="card">
        <label>Intervalo m√≠nimo</label>
        <input id="min-number" type="number" value="1" min="0"/>
        <label>Intervalo m√°ximo</label>
        <input id="max-number" type="number" value="60" min="1"/>
        <label>Tamanho da cartela</label>
        <select id="grid-size"><option value="3">3 √ó 3 (9)</option><option value="5" selected>5 √ó 5 (25)</option><option value="7">7 √ó 7 (49)</option></select>
        <label>Quantidade de cartelas</label>
        <input id="card-count" type="number" value="4" min="1" max="60"/>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btn-generate">Gerar cartelas</button>
          <button class="btn ghost" data-target="home">Voltar</button>
        </div>
        <div id="gen-alert" class="alert danger" style="display:none"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Pr√©-visualiza√ß√£o</strong>
          <button class="btn success" id="btn-pdf">Exportar PDF (4 por p√°gina)</button>
        </div>
        <div id="generated-info" class="kpi" style="display:none;margin-top:10px"></div>
        <div id="cards-preview" class="cards-wrap" style="margin-top:12px"></div>
      </div>
    </div>
  </section>

  <!-- CONFIGURA√á√ÉO -->
  <section id="config" class="screen section glass">
    <h2>Configura√ß√µes do sorteio</h2>
    <p class="hint">Configure dificuldade, opera√ß√µes, intervalos e timers. Voc√™ pode iniciar sem cartelas geradas.</p>

    <div class="grid-2">
      <div class="card">
        <label>Dificuldade</label>
        <select id="difficulty">
          <option value="easy">F√°cil ‚Äî 2 n√∫meros, 1 opera√ß√£o (sem par√™nteses)</option>
          <option value="normal">Normal ‚Äî 2 a 5 n√∫meros, at√© 3 opera√ß√µes</option>
          <option value="hard">Dif√≠cil ‚Äî 5 a 10 n√∫meros, at√© 4 opera√ß√µes (par√™nteses/colchetes)</option>
        </select>

        <label>Opera√ß√µes</label>
        <div class="row" style="margin-top:6px">
          <label class="switch"><input type="checkbox" id="op-add" checked><span class="toggle"><span class="dot"></span></span><span class="tiny">+</span></label>
          <label class="switch"><input type="checkbox" id="op-sub" checked><span class="toggle"><span class="dot"></span></span><span class="tiny">‚àí</span></label>
          <label class="switch"><input type="checkbox" id="op-mul" checked><span class="toggle"><span class="dot"></span></span><span class="tiny">√ó</span></label>
          <label class="switch"><input type="checkbox" id="op-div"><span class="toggle"><span class="dot"></span></span><span class="tiny">√∑</span></label>
        </div>

        <div class="sep"></div>
        <label>Intervalo dos n√∫meros nas express√µes</label>
        <select id="expr-range"><option value="100">1 ‚Äî 100</option><option value="300">1 ‚Äî 300</option><option value="500">1 ‚Äî 500</option></select>

        <label>Intervalo de sorteio (resultado final permitido)</label>
        <div class="row">
          <input id="draw-min" type="number" value="1" style="max-width:160px"/>
          <input id="draw-max" type="number" value="100" style="max-width:160px"/>
        </div>
      </div>

      <div class="card">
        <h3>Timers</h3>
        <p class="tiny">Ative o autom√°tico para sortear periodicamente; o cron√¥metro limita a sess√£o.</p>
        <label>Intervalo autom√°tico (segundos, 0 = desativado)</label>
        <input id="auto-interval" type="number" value="0" min="0"/>
        <label>Cron√¥metro regressivo (minutos, 0 = sem limite)</label>
        <input id="countdown" type="number" value="0" min="0"/>
        <div class="sep"></div>
        <div class="row">
          <button class="btn success" onclick="startGame()">Iniciar sorteio</button>
          <button class="btn ghost" data-target="home">Voltar</button>
        </div>
        <div id="cfg-alert" class="alert danger" style="display:none"></div>
      </div>
    </div>
  </section>

  <!-- SORTEIO -->
  <section id="draw" class="screen section glass">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Sorteio em andamento</h2>
      <div class="kpi">Tempo: <strong id="countdown-display" style="margin-left:8px">--:--</strong></div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div id="current-expression" class="expression">Pronto para sortear‚Ä¶</div>

        <div class="row">
          <button class="btn" onclick="drawExpression()">Sortear express√£o</button>
          <button class="btn success" onclick="clearDraws()">Limpar sorteio</button>
          <button class="btn danger" onclick="stopTimers()">Parar timers</button>
          <button class="btn ghost" data-target="home" onclick="stopTimers()">Encerrar</button>
        </div>

        <div id="draw-alert" class="alert warn" style="display:none"></div>
        <div class="sep"></div>

        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Hist√≥rico</h3>
          <div>
            <button class="small-ghost" onclick="exportHistoryCSV()">üì• Exportar CSV</button>
          </div>
        </div>

        <div id="history" class="history" aria-live="polite"></div>
      </div>

      <div class="card">
        <h3>Verifica√ß√µes</h3>
        <label>Digite um n√∫mero</label>
        <div class="row">
          <input type="number" id="check-number" style="max-width:180px"/>
          <button class="btn" onclick="checkNumber()">Verificar</button>
        </div>
        <div id="check-result" class="alert" style="display:none;margin-top:12px"></div>

        <div class="sep"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="display:flex;align-items:center;gap:10px">
            <strong>Exibir cartelas</strong>
            <label class="switch"><input type="checkbox" id="toggle-cards"/><span class="toggle"><span class="dot"></span></span></label>
          </div>

          <!-- NOVA OP√á√ÉO: marcar n√∫meros sorteados -->
          <div style="display:flex;align-items:center;gap:10px">
            <strong>Marcar sorteados</strong>
            <label class="switch"><input type="checkbox" id="toggle-marked"/><span class="toggle"><span class="dot"></span></span></label>
          </div>
        </div>

        <div id="cards-on-draw" class="cards-wrap" style="margin-top:12px;display:none"></div>
      </div>
    </div>
  </section>

  <footer>¬© 2025 ‚Äî Bingo Matem√°tico</footer>
</div>

<script>
/* -------------------------
   Estado global / estruturas
   ------------------------- */
let generatedCards = [];
let cardSize = 5;
let expressionsCanon = new Set();
let resultsSet = new Set();
let resultToDisplay = {}; // map result -> display expression
let autoTimer = null, countdownTimer = null, timeLeft = 0;

/* ---------- Navega√ß√£o ---------- */
document.querySelectorAll("[data-target]").forEach(btn=>{
  btn.addEventListener("click", ()=> showScreen(btn.getAttribute("data-target")));
});
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  const el = document.getElementById(id);
  if(el) el.classList.add("active");
  if(id === "draw") syncCardsOnDraw();
}

/* -------------------------
   Gera√ß√£o de cartelas
   ------------------------- */
const elGenAlert = document.getElementById("gen-alert");
const elGeneratedInfo = document.getElementById("generated-info");
const elCardsPreview = document.getElementById("cards-preview");
document.getElementById("btn-generate").addEventListener("click", ()=>{
  elGenAlert.style.display = "none";
  const min = parseInt(document.getElementById("min-number").value);
  const max = parseInt(document.getElementById("max-number").value);
  const size = parseInt(document.getElementById("grid-size").value);
  const count = parseInt(document.getElementById("card-count").value);

  if(isNaN(min)||isNaN(max)||isNaN(size)||isNaN(count)){ return showGenError("Preencha todos os campos corretamente."); }
  if(max < min) return showGenError("O m√°ximo deve ser maior ou igual ao m√≠nimo.");
  const needed = size * size;
  const available = (max - min + 1);
  if(available < needed) return showGenError(`Intervalo insuficiente: precisa de ${needed} n√∫meros √∫nicos mas h√° ${available}.`);
  if(count < 1 || count > 60) return showGenError("Quantidade de cartelas deve ser entre 1 e 60.");

  cardSize = size;
  generatedCards = [];
  for(let i=0;i<count;i++) generatedCards.push(generateUniqueCard(min, max, size));
  renderCardsPreview(elCardsPreview, generatedCards, size, false); // preview without marks
  elGeneratedInfo.style.display = "flex";
  elGeneratedInfo.textContent = `Geradas ${count} cartelas (${size}√ó${size}) ‚Äî n√∫meros ${min} a ${max}.`;

  saveStateLocal(false);
});

function showGenError(msg){ elGenAlert.textContent = msg; elGenAlert.style.display = "block"; }

function generateUniqueCard(min, max, size){
  const total = size * size;
  const pool = [];
  for(let n=min;n<=max;n++) pool.push(n);
  for(let i=pool.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [pool[i],pool[j]]=[pool[j],pool[i]];
  }
  return pool.slice(0,total);
}

/* renderCardsPreview(container, cards, size, markNumbers)
   markNumbers -> if true will highlight numbers present in resultsSet */
function renderCardsPreview(container, cards, size, markNumbers=false){
  container.innerHTML = "";
  cards.forEach((nums, idx)=>{
    const card = document.createElement("div"); card.className = "card";
    const title = document.createElement("div"); title.style.display="flex"; title.style.justifyContent="space-between"; title.style.marginBottom="8px";
    title.innerHTML = `<strong>Cartela ${idx+1}</strong><span class="tiny muted">${size}√ó${size}</span>`;
    const grid = document.createElement("div"); grid.className = "ticket-grid"; grid.dataset.size = String(size);
    nums.forEach(n=>{
      const cell = document.createElement("div"); cell.className = "cell"; cell.textContent = n;
      cell.style.fontSize = "1.1rem";
      if(markNumbers && resultsSet.has(n)){
        cell.classList.add('marked');
      }
      grid.appendChild(cell);
    });
    card.appendChild(title); card.appendChild(grid); container.appendChild(card);
  });
}

/* PDF export ‚Äî 4 per A4 landscape, white background, modern card */
document.getElementById("btn-pdf").addEventListener("click", ()=>{
  if(!generatedCards.length){
    showGenError("Gere cartelas antes de exportar o PDF."); return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4', orientation:'landscape' });
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 28;
  const perRow = 2, perCol = 2;
  const cardW = (pageW - margin*(perRow+1))/perRow;
  const cardH = (pageH - margin*(perCol+1))/perCol;

  for(let i=0;i<generatedCards.length;i++){
    if(i>0 && i%(perRow*perCol)===0) doc.addPage();
    const pageIndex = i % (perRow*perCol);
    const col = pageIndex % perRow;
    const row = Math.floor(pageIndex / perRow);
    const x = margin + col*(cardW + margin);
    const y = margin + row*(cardH + margin);
    drawCardPDF(doc, generatedCards[i], x, y, cardW, cardH, cardSize, i+1);
  }
  doc.save('cartelas-bingo.pdf');
});

function drawCardPDF(doc, nums, x, y, w, h, size, cardNum){
  // white card background
  doc.setFillColor(255,255,255);
  doc.rect(x, y, w, h, 'F'); // fill white
  // header strip
  const headerH = Math.max(28, h * 0.12);
  doc.setFillColor(138,99,255);
  doc.rect(x, y, w, headerH, 'F');
  // title
  doc.setFontSize(12); doc.setTextColor(255,255,255); doc.setFont('helvetica','bold');
  doc.text(`Cartela ${cardNum}`, x + w/2, y + headerH/2 + 4, {align:'center', baseline:'middle'});

  // grid
  const gridTop = y + headerH + 12;
  const gridH = h - headerH - 24;
  const gridW = w - 24;
  const cellSize = Math.min(Math.floor(gridW/size), Math.floor(gridH/size));
  const offsetX = x + (w - cellSize*size)/2;
  const offsetY = gridTop + (gridH - cellSize*size)/2;

  doc.setDrawColor(60,60,60);
  doc.setLineWidth(0.9);
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      const cx = offsetX + c*cellSize;
      const cy = offsetY + r*cellSize;
      doc.rect(cx, cy, cellSize, cellSize);
      const n = nums[r*size + c];
      const fontSize = Math.min(Math.max(20, Math.floor(cellSize * 0.5)), 64);
      doc.setFontSize(fontSize);
      doc.setTextColor(20,20,20);
      doc.setFont('helvetica','bold');
      doc.text(String(n), cx + cellSize/2, cy + cellSize/2 + fontSize*0.06, {align:'center', baseline:'middle'});
    }
  }
}

/* -------------------------
   Sorteio & timers
   ------------------------- */
const elCfgAlert = document.getElementById("cfg-alert");
const elDrawAlert = document.getElementById("draw-alert");
const elHistory = document.getElementById("history");
const elCurrentExpression = document.getElementById("current-expression");
const elCountdownDisplay = document.getElementById("countdown-display");

function startGame(){
  elCfgAlert.style.display = "none"; elDrawAlert.style.display = "none";
  expressionsCanon = new Set(); resultsSet = new Set(); resultToDisplay = {};
  elHistory.innerHTML = ""; elCurrentExpression.textContent = "Pronto para sortear‚Ä¶";
  stopTimers();

  const ops = getSelectedOps();
  if(ops.length === 0){ elCfgAlert.textContent = "Selecione ao menos uma opera√ß√£o."; elCfgAlert.style.display = "block"; return; }

  const autoInt = parseInt(document.getElementById("auto-interval").value || "0");
  if(autoInt > 0) autoTimer = setInterval(()=> drawExpression(), autoInt*1000);

  const mins = parseInt(document.getElementById("countdown").value || "0");
  if(mins > 0){
    timeLeft = mins * 60; updateCountdown();
    countdownTimer = setInterval(()=>{
      timeLeft--; updateCountdown();
      if(timeLeft <= 0){
        stopTimers();
        elDrawAlert.textContent = "Tempo esgotado ‚Äî timers parados."; elDrawAlert.className = "alert warn"; elDrawAlert.style.display = "block";
      }
    }, 1000);
  } else elCountdownDisplay.textContent = "--:--";

  showScreen("draw");
}

function stopTimers(){ if(autoTimer){clearInterval(autoTimer);autoTimer=null;} if(countdownTimer){clearInterval(countdownTimer);countdownTimer=null;} }
function updateCountdown(){ const m=Math.floor(timeLeft/60), s=timeLeft%60; elCountdownDisplay.textContent = `${m}:${String(s).padStart(2,'0')}`; }

function clearDraws(){
  expressionsCanon = new Set(); resultsSet = new Set(); resultToDisplay = {};
  elHistory.innerHTML = ""; elCurrentExpression.textContent = "Pronto para sortear‚Ä¶"; elDrawAlert.style.display = "none";
  // refresh marks on visible cards
  updateCardMarks();
  saveStateLocal(false);
}

/* Core: gera express√£o garantindo resultado inteiro (n√£o aceita decimais) */
function drawExpression(){
  elDrawAlert.style.display = "none";
  const difficulty = document.getElementById("difficulty").value;
  const exprRange = parseInt(document.getElementById("expr-range").value || "300");
  const drawMin = parseInt(document.getElementById("draw-min").value || "1");
  const drawMax = parseInt(document.getElementById("draw-max").value || "100");
  if(drawMax < drawMin){ elDrawAlert.textContent = "Intervalo de sorteio inv√°lido (m√°x < m√≠n)."; elDrawAlert.className = "alert danger"; elDrawAlert.style.display = "block"; return; }

  let tries = 0; let chosen = null;
  while(tries < 600){
    tries++;
    const candidate = generateExpressionWithPlain(difficulty, exprRange);
    if(!candidate) continue;
    if(candidate.result === undefined || candidate.result === null || !Number.isFinite(candidate.result)) continue;
    if(!Number.isInteger(candidate.result)) continue; // reject decimals
    if(candidate.result < drawMin || candidate.result > drawMax) continue;
    const canon = canonicalize(candidate.plainEvalExpr);
    if(expressionsCanon.has(canon)) continue;
    if(resultsSet.has(candidate.result)) continue;
    chosen = candidate; break;
  }
  if(!chosen){ elDrawAlert.textContent = "N√£o foi poss√≠vel gerar express√£o inteira e √∫nica. Ajuste op√ß√µes/intervalos."; elDrawAlert.className = "alert danger"; elDrawAlert.style.display = "block"; return; }

  const canonChosen = canonicalize(chosen.plainEvalExpr);
  expressionsCanon.add(canonChosen);
  resultsSet.add(chosen.result);
  resultToDisplay[chosen.result] = chosen.displayExpr;

  elCurrentExpression.textContent = chosen.displayExpr + "  =  ?";
  const item = document.createElement("div"); item.className = "item"; item.textContent = `${chosen.displayExpr}  =  (?)`;
  elHistory.prepend(item);

  // update card marks if visible and toggle enabled
  updateCardMarks();

  saveStateLocal(false);
}

/* generateExpressionWithPlain similar to earlier version */
function generateExpressionWithPlain(level, range){
  const ops = getSelectedOps(); const opsCount = Math.max(ops.length, 1);
  let numsCount = 2, maxOps = 1;
  if(level==="easy"){ numsCount=2; maxOps=1; }
  else if(level==="normal"){ numsCount = randInt(2,5); maxOps = Math.min(3, opsCount); }
  else { numsCount = randInt(5,10); maxOps = Math.min(4, opsCount); }

  const useOps = sampleOps(ops, maxOps);
  const numbers = Array.from({length: numsCount}, ()=> randInt(1, range));

  const tokens = [ String(numbers[0]) ];
  for(let i=1;i<numsCount;i++){
    let op = useOps[randInt(0, useOps.length-1)];
    let n = numbers[i];
    if(op === "/"){
      if(n === 0) n = 1;
      const prevToken = tokens[tokens.length-1];
      const prevNum = Number(prevToken);
      if(Number.isInteger(prevNum) && prevNum > 0 && Math.random() < 0.45){
        const divs = divisors(prevNum).filter(d=>d>0);
        if(divs.length) n = divs[randInt(0, divs.length-1)];
      }
    }
    tokens.push(op, String(n));
  }

  let groupedTokens = tokens.slice();
  if(level === "hard"){
    if(Math.random() < 0.28) groupedTokens = applyGrouping(groupedTokens);
  } else if(level === "normal"){
    if(Math.random() < 0.12) groupedTokens = applyGroupingOnce(groupedTokens, "()"); 
  }

  const plainEvalExpr = groupedTokens.join(" ");
  let displayExpr = plainEvalExpr.replace(/\*/g, " √ó ").replace(/\//g, " √∑ ");
  displayExpr = displayExpr.replace(/\s+/g,' ').trim();

  let result = NaN;
  try{
    result = Function(`"use strict"; return (${plainEvalExpr.replace(/\[/g,'(').replace(/\]/g,')')});`)();
  }catch(e){ result = NaN; }
  if(!Number.isFinite(result)) return null;
  return { displayExpr, plainEvalExpr, result };
}

/* grouping helpers */
function applyGrouping(tokens){ let out = tokens.slice(); out = applyGroupingOnce(out, Math.random()<0.5 ? "()" : "[]"); if(Math.random() < 0.22) out = applyGroupingOnce(out, Math.random()<0.5 ? "()" : "[]"); return out; }
function applyGroupingOnce(tokens, bracket="()"){ if(tokens.length<5) return tokens; const numIdxs=[]; for(let i=0;i<tokens.length;i+=2) numIdxs.push(i); if(numIdxs.length<2) return tokens; const i1 = numIdxs[randInt(0,numIdxs.length-2)]; const i2 = numIdxs[randInt(i1+1,numIdxs.length-1)]; const open=bracket[0], close=bracket[1]; return tokens.slice(0,i1).concat([open], tokens.slice(i1,i2+1), [close], tokens.slice(i2+1)); }

/* canonicalize plain expression (for uniqueness) */
function canonicalize(s){ return s.replace(/\s+/g,'').replace(/\[/g,'(').replace(/\]/g,')'); }

/* -------------------------
   Verifica√ß√£o de n√∫mero
   ------------------------- */
function checkNumber(){
  const el = document.getElementById("check-result");
  const raw = document.getElementById("check-number").value;
  const n = parseInt(raw);
  if(isNaN(n)){ el.className="alert danger"; el.style.display="block"; el.textContent="Digite um n√∫mero v√°lido."; return; }
  const inCards = generatedCards.length ? generatedCards.some(card => card.includes(n)) : false;
  const wasDrawn = resultsSet.has(n);
  el.style.display = "block";
  if(wasDrawn){
    const expr = resultToDisplay[n] || "(express√£o n√£o encontrada)";
    if(inCards){
      el.className="alert success";
      el.textContent = `‚úî O n√∫mero ${n} foi sorteado e est√° em uma cartela. Express√£o: ${expr} = ${n}`;
    } else {
      el.className="alert warn";
      el.textContent = `‚Ä¢ O n√∫mero ${n} foi sorteado (express√£o: ${expr} = ${n}), mas n√£o consta nas cartelas geradas.`;
    }
  } else {
    if(inCards){ el.className="alert warn"; el.textContent = `‚Ä¢ O n√∫mero ${n} est√° em alguma cartela, mas ainda N√ÉO foi sorteado.`; }
    else { el.className="alert danger"; el.textContent = `‚úñ O n√∫mero ${n} n√£o est√° nas cartelas e n√£o foi sorteado.`; }
  }

  // also update visual marks (useful after manual verify)
  updateCardMarks();
}

/* -------------------------
   Mostrar cartelas e marcar sorteados
   ------------------------- */
document.getElementById("toggle-cards").addEventListener("change", (e)=>{
  const box = document.getElementById("cards-on-draw");
  if(e.target.checked){
    syncCardsOnDraw();
    box.style.display = "grid";
  } else {
    box.style.display = "none";
  }
});
document.getElementById("toggle-marked").addEventListener("change", (e)=>{
  updateCardMarks();
});

function syncCardsOnDraw(){
  const box = document.getElementById("cards-on-draw");
  box.innerHTML = "";
  if(!generatedCards.length){
    const empty = document.createElement("div"); empty.className="card"; empty.textContent="Nenhuma cartela gerada.";
    box.appendChild(empty); return;
  }
  const shouldMark = document.getElementById("toggle-marked").checked;
  renderCardsPreview(box, generatedCards, cardSize, shouldMark);
}

/* updateCardMarks() percorre as cartelas DOM em #cards-on-draw e aplica/removes .marked
   chamamos sempre que resultsSet muda, ao ativar toggle-marked, ao gerar/limpar, ao carregar estado */
function updateCardMarks(){
  const box = document.getElementById("cards-on-draw");
  if(!box || box.children.length===0) return;
  const shouldMark = document.getElementById("toggle-marked").checked;
  // percorre cada card e atualiza c√©lulas
  const cardDivs = box.querySelectorAll('.card');
  cardDivs.forEach((cardDiv, idx)=>{
    const cells = cardDiv.querySelectorAll('.cell');
    cells.forEach(cell => {
      const val = parseInt(cell.textContent);
      if(shouldMark && resultsSet.has(val)){
        cell.classList.add('marked');
      } else {
        cell.classList.remove('marked');
      }
    });
  });
}

/* -------------------------
   Export hist√≥rico CSV
   ------------------------- */
function exportHistoryCSV(){
  const rows = [];
  const items = document.querySelectorAll('#history .item');
  items.forEach(it=>{
    const txt = it.textContent || "";
    const expr = txt.replace(' = (?)','').trim();
    let resultFound = Object.keys(resultToDisplay).find(k => resultToDisplay[k] === expr);
    if(!resultFound){
      try{
        const plain = expr.replace(/√ó/g,'*').replace(/√∑/g,'/').replace(/\[/g,'(').replace(/\]/g,')');
        const val = Function(`"use strict"; return (${plain});`)();
        if(Number.isFinite(val)) resultFound = String(Math.round(val));
      }catch(e){}
    }
    rows.push([expr, resultFound || ""]);
  });
  let csv = "Express√£o;Resultado\n";
  rows.forEach(r => { csv += `${r[0]};${r[1]}\n`; });
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'historico_bingo.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* -------------------------
   Estado persistente (localStorage)
   ------------------------- */
function saveState(){ saveStateLocal(true); }
function saveStateLocal(showAlert){
  try{
    const state = {
      generatedCards, cardSize,
      expressions: Array.from(expressionsCanon || []),
      results: Array.from(resultsSet || []),
      resultToDisplay,
      settings: {
        difficulty: document.getElementById("difficulty").value,
        exprRange: document.getElementById("expr-range").value,
        drawMin: document.getElementById("draw-min").value,
        drawMax: document.getElementById("draw-max").value,
        autoInterval: document.getElementById("auto-interval").value,
        countdown: document.getElementById("countdown").value
      }
    };
    localStorage.setItem('bingo_state_v1', JSON.stringify(state));
    if(showAlert) alert("Estado salvo no navegador (localStorage).");
  }catch(e){ if(showAlert) alert("Falha ao salvar estado: " + e.message); }
}
function loadState(){
  try{
    const raw = localStorage.getItem('bingo_state_v1');
    if(!raw){ alert("Nenhum estado salvo encontrado."); return; }
    const state = JSON.parse(raw);
    generatedCards = state.generatedCards || [];
    cardSize = state.cardSize || 5;
    expressionsCanon = new Set(state.expressions || []);
    resultsSet = new Set(state.results || []);
    resultToDisplay = state.resultToDisplay || {};
    if(state.settings){
      document.getElementById("difficulty").value = state.settings.difficulty || "normal";
      document.getElementById("expr-range").value = state.settings.exprRange || "300";
      document.getElementById("draw-min").value = state.settings.drawMin || "1";
      document.getElementById("draw-max").value = state.settings.drawMax || "100";
      document.getElementById("auto-interval").value = state.settings.autoInterval || "0";
      document.getElementById("countdown").value = state.settings.countdown || "0";
    }
    renderCardsPreview(document.getElementById("cards-preview"), generatedCards, cardSize, false);
    // if cards visible on draw, refresh them and marks
    if(document.getElementById("toggle-cards").checked) syncCardsOnDraw();
    updateCardMarks();
    alert("Estado carregado do armazenamento local.");
  }catch(e){ alert("Falha ao carregar estado: "+ e.message); }
}
function clearState(){
  if(!confirm("Deseja realmente apagar o estado salvo no navegador?")) return;
  localStorage.removeItem('bingo_state_v1');
  alert("Estado apagado.");
}

/* -------------------------
   Utilit√°rios
   ------------------------- */
function getSelectedOps(){
  const out = [];
  if(document.getElementById("op-add").checked) out.push("+");
  if(document.getElementById("op-sub").checked) out.push("-");
  if(document.getElementById("op-mul").checked) out.push("*");
  if(document.getElementById("op-div").checked) out.push("/");
  return out;
}
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function sampleOps(ops, maxCount){ if(!ops || ops.length===0) return ["+"]; if(maxCount>=ops.length) return ops.slice(); const arr=ops.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr.slice(0,maxCount); }
function divisors(n){ n=Math.abs(Math.floor(n)); const out=[]; for(let i=1;i<=Math.sqrt(n);i++){ if(n%i===0){ out.push(i); if(n/i!==i) out.push(Math.floor(n/i)); }} return out; }
function canonicalize(s){ return s.replace(/\s+/g,'').replace(/\[/g,'(').replace(/\]/g,')'); }

/* Inicializa√ß√£o */
(function init(){
  showScreen('home');
  document.getElementById('cards-on-draw').style.display = 'none';
})();
</script>
</body>
</html>
