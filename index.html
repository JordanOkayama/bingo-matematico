<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bingo Matem√°tico ‚Äî V2</title>

<!-- jsPDF (opcional, para exportar cartelas) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --primary:#1b6bf2;
    --primary-600:#1354c2;
    --accent:#16a085;
    --danger:#ef4444;
    --bg:#0f172a; /* slate-900 */
    --glass: rgba(255,255,255,0.08);
    --card:#0b1225;
    --muted:#94a3b8;
    --ok:#16a34a;
    --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    color:#e5e7eb;
    background:
      radial-gradient(1200px 800px at 100% 0%, rgba(27,107,242,.15), transparent 60%),
      radial-gradient(1000px 600px at 0% 100%, rgba(22,160,133,.15), transparent 60%),
      linear-gradient(180deg,#0b1020 0%, #0c132e 60%, #0f172a 100%);
  }
  .container{
    width:100%;
    max-width:1200px;
    margin:0 auto;
    padding:24px;
  }
  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:18px 22px;margin-bottom:16px;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px;
    backdrop-filter: blur(8px);
    box-shadow: 0 20px 50px rgba(2,6,23,.4), inset 0 1px 0 rgba(255,255,255,.06);
  }
  header h1{font-size:1.2rem;margin:0;color:#fff;letter-spacing:.3px}
  .screen{display:none}
  .screen.active{display:block}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1;min-width:240px}
  label{display:block;font-weight:700;margin-bottom:6px;color:#cbd5e1;font-size:.92rem}
  input[type=number], select, input[type=text]{
    width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.09);
    background:rgba(255,255,255,.06); color:#e5e7eb; outline:none;
  }
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
  input[type=checkbox]{transform:scale(1.15);margin-right:8px}
  .btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:12px 18px;border-radius:999px;border:1px solid transparent;
    background:linear-gradient(180deg,var(--primary),var(--primary-600));
    color:#fff;font-weight:800;cursor:pointer;letter-spacing:.3px;
    box-shadow:0 10px 30px rgba(27,107,242,.35);
  }
  .btn.secondary{background:linear-gradient(180deg,var(--accent),#10836f);box-shadow:0 10px 30px rgba(22,160,133,.35)}
  .btn.ghost{background:transparent;border-color:rgba(255,255,255,.16);color:#e5e7eb}
  .btn.warn{background:linear-gradient(180deg,#f59e0b,#c27807)}
  .btn.danger{background:linear-gradient(180deg,#ef4444,#b91c1c)}
  .controls{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px;padding:18px 18px 14px 18px;margin-bottom:16px;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
  }
  .hero{
    display:grid;grid-template-columns: repeat( auto-fit, minmax(260px, 1fr) ); gap:16px;
  }
  .hero-card{
    padding:20px;border-radius:18px;border:1px solid rgba(255,255,255,.08);
    background: radial-gradient(600px 300px at 20% -10%, rgba(27,107,242,.25), transparent 40%),
                radial-gradient(600px 300px at 120% 120%, rgba(22,160,133,.22), transparent 40%),
                rgba(255,255,255,.05);
    display:flex;flex-direction:column;gap:10px;justify-content:space-between;
    box-shadow: 0 16px 50px rgba(2,6,23,.45);
  }
  .hero-card h3{margin:0;color:#fff}
  .hero-card p{margin:0;color:#cbd5e1}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:.86rem;color:#cbd5e1}
  .muted{color:#94a3b8}
  .warn{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.25);color:#fde68a;padding:10px;border-radius:12px;display:none}
  .ok{background:rgba(22,163,74,.12);border:1px solid rgba(22,163,74,.25);color:#86efac;padding:10px;border-radius:12px;display:none}
  .card-preview{display:grid;gap:6px}
  .cell{
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.1);
    padding:12px;text-align:center;border-radius:10px;font-weight:800;min-height:52px;
    display:flex;align-items:center;justify-content:center;color:#e2e8f0;
  }
  .cell.free{background:linear-gradient(180deg,var(--primary),var(--primary-600));color:#fff;border-color:transparent}
  .cell.marked{background:linear-gradient(180deg,#ffd59e,#ffb26a);border-color:#ffb26a;color:#1f2937}
  .pdf-preview{display:grid;grid-template-columns:repeat( auto-fit, minmax(260px, 1fr) ); gap:12px}
  .pdf-card{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05)}
  .game-area{display:grid;grid-template-columns: 1.7fr 1fr;gap:16px}
  @media (max-width:980px){.game-area{grid-template-columns:1fr}}
  .history{max-height:320px;overflow:auto;border:1px dashed rgba(255,255,255,.18);padding:10px;border-radius:12px;background:rgba(255,255,255,.03)}
  .expression-display{
    font-size:1.6rem;font-weight:900;text-align:center;
    padding:16px;border-radius:14px;background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);min-height:70px
  }
  .number-display{font-size:2.2rem;font-weight:900;color:#fff;text-align:center}
  .cards-list{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width:680px){.cards-list{grid-template-columns:1fr}}
  .cartela{border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px;background:rgba(255,255,255,.04)}
  .cartela-title{font-weight:900;color:#e2e8f0;margin-bottom:8px;text-align:center}
  .notify{padding:10px;border-radius:12px}
  .notify.info{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.25)}
  .notify.success{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.25)}
  .notify.warn{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25)}
  .toggle{
    display:inline-flex;align-items:center;gap:10px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.05);cursor:pointer;
  }
  .toggle input{transform:scale(1.1)}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üéØ Bingo Matem√°tico</h1>
      <div class="chip">Vers√£o 2 ‚Äî mais esperto & bonito</div>
    </header>

    <!-- HOME -->
    <section id="home" class="screen active">
      <div class="hero">
        <div class="hero-card">
          <div>
            <h3>üß© Gerar cartela</h3>
            <p>Crie cartelas N√óN com ou sem FREE central e exporte para PDF.</p>
          </div>
          <div class="controls"><button class="btn" data-target="generate">Gerar cartela</button></div>
        </div>
        <div class="hero-card">
          <div>
            <h3>üé≤ Come√ßar sorteio</h3>
            <p>Configure opera√ß√µes, dificuldade e intervalos. Inicie o sorteio (com ou sem cartelas).</p>
          </div>
          <div class="controls"><button class="btn secondary" data-target="config">Come√ßar sorteio</button></div>
        </div>
      </div>
    </section>

    <!-- GERA√á√ÉO DE CARTELAS -->
    <section id="generate" class="screen">
      <div class="panel">
        <h2>üß© Gerar cartelas</h2>
        <div class="row">
          <div class="col">
            <label for="min-number">N√∫mero m√≠nimo na cartela</label>
            <input id="min-number" type="number" value="1" min="0">
          </div>
          <div class="col">
            <label for="max-number">N√∫mero m√°ximo na cartela</label>
            <input id="max-number" type="number" value="50" min="1">
          </div>
          <div class="col">
            <label for="grid-size">Tamanho da cartela (N √ó N)</label>
            <select id="grid-size">
              <option value="3">3 √ó 3</option>
              <option value="4">4 √ó 4</option>
              <option value="5" selected>5 √ó 5</option>
              <option value="6">6 √ó 6</option>
              <option value="7">7 √ó 7</option>
              <option value="8">8 √ó 8</option>
              <option value="9">9 √ó 9</option>
            </select>
          </div>
          <div class="col">
            <label for="card-count">Quantidade de cartelas</label>
            <input id="card-count" type="number" value="6" min="1" max="200">
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="col" style="min-width:240px">
            <label class="toggle"><input id="free-center" type="checkbox" checked> Incluir FREE no centro (se N √≠mpar)</label>
          </div>
          <div class="col" style="min-width:240px">
            <label class="toggle"><input id="allow-repeats" type="checkbox"> Permitir repeti√ß√µes se intervalo insuficiente</label>
          </div>
        </div>

        <div id="validation" class="warn" style="margin-top:10px"></div>
        <div id="validation-ok" class="ok" style="margin-top:10px"></div>

        <div style="margin-top:14px">
          <h3 class="muted" style="margin:0 0 6px 0">Pr√©-visualiza√ß√£o</h3>
          <div id="card-preview" class="card-preview"></div>
        </div>

        <div class="controls" style="margin-top:14px">
          <button id="btn-generate" class="btn">Gerar cartelas</button>
          <button class="btn ghost" data-target="home">Voltar</button>
        </div>
      </div>

      <div id="generated-area" class="panel" style="display:none">
        <h3>Cartelas geradas</h3>
        <div id="generated-count" class="muted" style="margin-bottom:8px"></div>
        <div id="generated-cards-list" class="pdf-preview"></div>
        <div class="controls">
          <button id="btn-pdf" class="btn">Exportar PDF</button>
          <button class="btn ghost" onclick="document.getElementById('generated-area').style.display='none'">Fechar</button>
        </div>
      </div>
    </section>

    <!-- CONFIGURA√á√ïES + INICIAR -->
    <section id="config" class="screen">
      <div class="panel">
        <h2>üéõÔ∏è Configura√ß√µes do sorteio</h2>
        <div class="row" style="margin-top:6px">
          <div class="col" style="min-width:260px">
            <label>Opera√ß√µes</label>
            <div class="toggle"><input id="op-add" type="checkbox" checked> Adi√ß√£o (+)</div>
            <div class="toggle" style="margin-top:8px"><input id="op-sub" type="checkbox" checked> Subtra√ß√£o (‚àí)</div>
            <div class="toggle" style="margin-top:8px"><input id="op-mul" type="checkbox"> Multiplica√ß√£o (√ó)</div>
            <div class="toggle" style="margin-top:8px"><input id="op-div" type="checkbox"> Divis√£o (√∑)</div>
          </div>

          <div class="col">
            <label for="expr-difficulty">Dificuldade da express√£o</label>
            <select id="expr-difficulty">
              <option value="easy">F√°cil ‚Äî 2 n√∫meros, 1 opera√ß√£o (sem par√™nteses)</option>
              <option value="normal" selected>Normal ‚Äî 2 a 5 n√∫meros, at√© 3 opera√ß√µes</option>
              <option value="hard">Dif√≠cil ‚Äî 5 a 10 n√∫meros, at√© 4 opera√ß√µes + par√™nteses/colchetes</option>
            </select>
          </div>

          <div class="col">
            <label for="expr-interval">Intervalo dos n√∫meros usados nas express√µes</label>
            <select id="expr-interval">
              <option value="100">1 ‚Äî 100</option>
              <option value="300" selected>1 ‚Äî 300</option>
              <option value="500">1 ‚Äî 500</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>Intervalo de sorteio (resultado alvo)</label>
            <div class="row" style="gap:8px">
              <div class="col">
                <input id="draw-min" type="number" value="1" min="1" aria-label="m√≠nimo do sorteio">
              </div>
              <div class="col">
                <input id="draw-max" type="number" value="50" min="1" aria-label="m√°ximo do sorteio">
              </div>
            </div>
            <div class="muted" style="margin-top:6px">Esse √© o intervalo dos <b>n√∫meros sorteados</b> (o resultado final das express√µes).</div>
          </div>
        </div>

        <div id="config-info" class="ok" style="display:block;margin-top:12px">Defina e clique em <b>Salvar</b> ou <b>Iniciar sorteio</b>.</div>

        <div class="controls" style="margin-top:10px">
          <button class="btn" onclick="applyConfig()">Salvar</button>
          <button class="btn secondary" onclick="startGame()">Iniciar sorteio</button>
          <button class="btn ghost" data-target="home">Voltar</button>
        </div>
      </div>
    </section>

    <!-- SORTEIO / JOGO -->
    <section id="game" class="screen">
      <div class="panel">
        <h2>üé≤ Sorteio</h2>
        <div class="row" style="align-items:center">
          <div class="col" style="min-width:240px">
            <label class="toggle"><input id="toggle-show-cards" type="checkbox" checked> Exibir cartelas na tela</label>
          </div>
          <div class="col muted" style="min-width:240px">
            Resultados √∫nicos: n√£o repetimos express√µes nem n√∫meros j√° sorteados.
          </div>
        </div>

        <div class="game-area" style="margin-top:12px">
          <div>
            <div class="expression-display" id="current-expression">Nenhuma express√£o sorteada</div>
            <div class="row" style="align-items:center;margin-top:10px">
              <div class="col" style="min-width:280px">
                <div class="controls">
                  <button class="btn" id="btn-draw" onclick="drawExpression()">Sortear express√£o</button>
                  <button class="btn ghost" id="btn-reveal" onclick="revealResult()">Revelar resultado</button>
                  <button class="btn warn" id="btn-reset" onclick="resetGame()">Reiniciar jogo</button>
                </div>
              </div>
              <div style="min-width:180px;text-align:right">
                <div class="muted">Resultado (oculto):</div>
                <div class="number-display" id="current-number">?</div>
              </div>
            </div>

            <div style="margin-top:12px">
              <div style="font-weight:800;margin-bottom:8px">Hist√≥rico</div>
              <div class="history" id="history-list"></div>
            </div>
          </div>

          <aside>
            <div class="notify info">
              <strong>Como usar</strong>
              <ul style="margin:6px 0 0 18px">
                <li>Configure e clique em <em>Sortear express√£o</em>. Apenas a express√£o aparece.</li>
                <li>Clique em <em>Revelar resultado</em> para mostrar o n√∫mero e marcar cartelas (se exibidas).</li>
                <li>Use o verificador para checar se um n√∫mero j√° saiu.</li>
              </ul>
            </div>

            <div style="margin-top:12px">
              <label for="verify-number">Verificar n√∫mero sorteado</label>
              <div class="row" style="gap:8px;margin-top:6px">
                <div class="col"><input id="verify-number" type="number" placeholder="N√∫mero..."></div>
                <div><button class="btn ghost" onclick="verifyNumber()">Verificar</button></div>
              </div>
              <div id="verify-result" style="margin-top:8px"></div>
            </div>

            <div id="winner-box" class="notify success" style="display:none;margin-top:12px"></div>
          </aside>
        </div>

        <div id="cards-block" style="margin-top:14px">
          <div style="font-weight:900;margin-bottom:8px">Cartelas (opcional)</div>
          <div id="cards-in-game" class="cards-list"></div>
        </div>

        <div class="controls">
          <button class="btn ghost" data-target="home">Voltar ao menu</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ======= Estado global =======
    let generatedCards = []; // cada cartela √© array linear N*N com n√∫meros ou 'FREE'
    let generatedCardSize = 5;
    let cardMin = 1, cardMax = 50;
    let allowRepeats = false, freeCenter = true;

    // Configura√ß√µes do sorteio
    let configOps = ['+','-'];
    let configExprDifficulty = 'normal';
    let configExprNumberMax = 300; // 100|300|500
    let drawRange = {min:1, max:50};

    // Jogo
    let historyExpressions = []; // [{display, result, plain}]
    let usedResults = new Set();
    let usedExpressions = new Set(); // forma can√¥nica
    let currentExpressionObj = null;
    let cardDomMap = []; // para atualizar marca√ß√µes visuais

    // ======= Navega√ß√£o =======
    document.querySelectorAll('[data-target]').forEach(btn=>{
      btn.addEventListener('click',()=>showScreen(btn.getAttribute('data-target')));
    });
    function showScreen(id){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      const el = document.getElementById(id);
      if(el) el.classList.add('active');
      if(id==='generate') updatePreview();
      if(id==='game'){
        renderGameCards();
        applyShowCardsToggle();
      }
    }

    // ======= UI: Toggle Exibir Cartelas =======
    document.getElementById('toggle-show-cards').addEventListener('change', applyShowCardsToggle);
    function applyShowCardsToggle(){
      const block = document.getElementById('cards-block');
      block.style.display = document.getElementById('toggle-show-cards').checked ? 'block' : 'none';
    }

    // ======= Gera√ß√£o de Cartelas =======
    const minInput = document.getElementById('min-number');
    const maxInput = document.getElementById('max-number');
    const sizeSelect = document.getElementById('grid-size');
    const freeCheckbox = document.getElementById('free-center');
    const repeatsCheckbox = document.getElementById('allow-repeats');
    const previewContainer = document.getElementById('card-preview');
    const validationEl = document.getElementById('validation');
    const validationOkEl = document.getElementById('validation-ok');
    const btnGenerate = document.getElementById('btn-generate');

    function refreshFreeOption(){
      const size = parseInt(sizeSelect.value,10);
      if(size%2===0){ freeCheckbox.checked=false; freeCheckbox.disabled=true; }
      else { freeCheckbox.disabled=false; }
    }

    [minInput,maxInput,freeCheckbox,repeatsCheckbox,sizeSelect].forEach(el=>{
      el.addEventListener('input', updatePreview);
      el.addEventListener('change', updatePreview);
    });

    function requiredNumbers(size, freeCenter){ return size*size - (freeCenter ? 1 : 0); }
    function availablePool(min,max){ return Math.max(0, max-min+1); }

    function updatePreview(){
      validationEl.style.display='none'; validationOkEl.style.display='none';
      previewContainer.innerHTML='';
      const min = +minInput.value||1;
      const max = +maxInput.value||1;
      const size = +sizeSelect.value;
      const free = !!freeCheckbox.checked;
      const allow = !!repeatsCheckbox.checked;
      refreshFreeOption();

      if(min>=max){ showWarn('M√≠nimo deve ser menor que o m√°ximo.'); btnGenerate.disabled=true; return; }
      const pool = availablePool(min,max);
      const req = requiredNumbers(size,free);
      if(pool<req && !allow){
        showWarn(`Intervalo insuficiente: precisa de ${req} n√∫meros distintos, mas h√° ${pool}. Marque "Permitir repeti√ß√µes" ou aumente o intervalo.`);
        btnGenerate.disabled=true; return;
      }
      showOk(`Ok: cartela ${size}√ó${size}, ${free? 'com':'sem'} FREE, ${allow?'permite':'n√£o permite'} repeti√ß√µes.`);
      btnGenerate.disabled=false;

      previewContainer.style.gridTemplateColumns=`repeat(${size},1fr)`;
      const card = safeGenerateBingoCard(min,max,size,free,allow);
      for(let i=0;i<size*size;i++){
        const d=document.createElement('div'); d.className='cell';
        const v=card[i]; d.textContent=(v==='FREE'?'FREE':String(v));
        if(v==='FREE') d.classList.add('free');
        previewContainer.appendChild(d);
      }
    }
    function showWarn(msg){ validationEl.textContent=msg; validationEl.style.display='block'; }
    function showOk(msg){ validationOkEl.textContent=msg; validationOkEl.style.display='block'; }

    function safeGenerateBingoCard(min,max,size,freeCenter,allowRepeats){
      const total = size*size;
      const needed = total - (freeCenter ? 1 : 0);
      const pool = availablePool(min,max);
      if(!allowRepeats && pool<needed) throw new Error('Pool insuficiente');

      const out = new Array(total);
      const nums = [];
      if(allowRepeats){ while(nums.length<needed) nums.push(rand(min,max)); }
      else{
        const set=new Set();
        while(set.size<needed) set.add(rand(min,max));
        nums.push(...set);
      }
      shuffle(nums);
      let idx=0;
      for(let r=0;r<size;r++){
        for(let c=0;c<size;c++){
          const pos=r*size+c;
          if(freeCenter && size%2===1 && r===Math.floor(size/2) && c===Math.floor(size/2)) out[pos]='FREE';
          else out[pos]=nums[idx++];
        }
      }
      return out;
    }

    document.getElementById('btn-generate').addEventListener('click', ()=>{
      const min=+minInput.value||1, max=+maxInput.value||1, size=+sizeSelect.value;
      const free=!!freeCheckbox.checked, count=+(document.getElementById('card-count').value||'1');
      const allow=!!repeatsCheckbox.checked;
      if(min>=max){ alert('M√≠nimo deve ser menor que m√°ximo.'); return; }
      const pool=availablePool(min,max), req=requiredNumbers(size,free);
      if(!allow && pool<req){ alert('Intervalo insuficiente para n√∫meros distintos.'); return; }

      generatedCards=[];
      for(let i=0;i<count;i++) generatedCards.push(safeGenerateBingoCard(min,max,size,free,allow));
      generatedCardSize=size; cardMin=min; cardMax=max; allowRepeats=allow; freeCenter=free;

      document.getElementById('generated-area').style.display='block';
      document.getElementById('generated-count').textContent=`Geradas ${generatedCards.length} cartelas ${size}√ó${size}.`;
      renderGeneratedCardsPreview();
      alert('Cartelas geradas com sucesso!');
    });

    function renderGeneratedCardsPreview(){
      const container=document.getElementById('generated-cards-list'); container.innerHTML='';
      for(let k=0;k<generatedCards.length;k++){
        const card=generatedCards[k];
        const cardDiv=document.createElement('div'); cardDiv.className='pdf-card';
        const title=document.createElement('div'); title.style.fontWeight=900; title.textContent=`Cartela ${k+1}`;
        cardDiv.appendChild(title);
        const grid=document.createElement('div');
        grid.style.display='grid'; grid.style.gridTemplateColumns=`repeat(${generatedCardSize},1fr)`; grid.style.gap='6px'; grid.style.marginTop='8px';
        for(let i=0;i<generatedCardSize*generatedCardSize;i++){
          const cell=document.createElement('div'); cell.className='cell';
          const v=card[i];
          if(v==='FREE'){ cell.classList.add('free'); cell.textContent='FREE'; }
          else cell.textContent=String(v);
          grid.appendChild(cell);
        }
        cardDiv.appendChild(grid);
        container.appendChild(cardDiv);
      }
    }

    document.getElementById('btn-pdf').addEventListener('click', ()=>{
      if(!generatedCards.length){ alert('Nenhuma cartela gerada.'); return; }
      const { jsPDF } = window.jspdf;
      const doc=new jsPDF({unit:'pt',format:'a4'});
      const pageW=doc.internal.pageSize.getWidth(), pageH=doc.internal.pageSize.getHeight();
      const margin=36, cardW=(pageW-margin*3)/2, cardH=(pageH-margin*3)/2;
      let x=margin, y=margin;
      for(let i=0;i<generatedCards.length;i++){
        if(i>0 && i%4===0){ doc.addPage(); x=margin; y=margin; }
        drawCardToPDF(doc, generatedCards[i], x, y, cardW, cardH, generatedCardSize, i+1);
        if((i%4)%2===0) x+=cardW+margin; else { x=margin; y+=cardH+margin; }
      }
      doc.save('cartelas-bingo.pdf');
    });

    function drawCardToPDF(doc, card, x,y,w,h,size, num){
      const cw=w/size, ch=h/size;
      doc.setDrawColor(60,110,200); doc.rect(x,y,w,h);
      for(let r=0;r<size;r++){
        for(let c=0;c<size;c++){
          const cx=x+c*cw, cy=y+r*ch, idx=r*size+c, val=card[idx];
          doc.rect(cx,cy,cw,ch);
          if(val==='FREE'){ doc.setFillColor(27,107,242); doc.rect(cx,cy,cw,ch,'F'); doc.setTextColor(255,255,255); }
          else doc.setTextColor(0,0,0);
          doc.setFontSize(Math.max(8, Math.min(20, cw/4)));
          doc.text(String(val), cx+cw/2, cy+ch/2, {align:'center',baseline:'middle'});
        }
      }
      doc.setFontSize(10); doc.setTextColor(60,110,200);
      doc.text(`Cartela ${num}`, x+w/2, y+h+12, {align:'center',baseline:'top'});
    }

    // ======= Configura√ß√µes do sorteio =======
    function applyConfig(){
      const ops=[];
      if(document.getElementById('op-add').checked) ops.push('+');
      if(document.getElementById('op-sub').checked) ops.push('-');
      if(document.getElementById('op-mul').checked) ops.push('√ó');
      if(document.getElementById('op-div').checked) ops.push('√∑');
      if(!ops.length){ alert('Selecione pelo menos uma opera√ß√£o.'); return; }
      const diff=document.getElementById('expr-difficulty').value;
      const numMax=+document.getElementById('expr-interval').value || 300;
      const dmin=+document.getElementById('draw-min').value||1, dmax=+document.getElementById('draw-max').value||50;
      if(dmin>=dmax){ alert('No intervalo de sorteio, o m√≠nimo deve ser menor que o m√°ximo.'); return; }

      configOps=ops;
      configExprDifficulty=diff;
      configExprNumberMax=numMax;
      drawRange={min:dmin,max:dmax};

      const info=document.getElementById('config-info');
      info.style.display='block';
      info.className='ok';
      info.innerHTML=`Configura√ß√µes salvas: opera√ß√µes [${configOps.join(' ')}], dificuldade <b>${diff}</b>, n√∫meros das express√µes 1‚Äì${numMax}, sorteio ${dmin}‚Äì${dmax}.`;
    }
    function startGame(){
      applyConfig(); // valida e salva
      showScreen('game');
    }

    // ======= Gera√ß√£o de Express√µes (AST + preced√™ncia) =======
    // N√≥s constru√≠mos uma AST que avalia exatamente para o alvo.
    // Depois renderizamos com par√™nteses m√≠nimos; no dif√≠cil, aplicamos colchetes de forma ocasional.
    const PREC = { '+':1, '-':1, '√ó':2, '√∑':2 };

    function drawExpression(){
      // Pode sortear sem cartelas
      applyConfigIfNotApplied();

      // tentar alvo √∫nico (sem repeti√ß√£o)
      const maxAttempts = 200;
      let tries=0, exprObj=null;
      while(tries<maxAttempts){
        tries++;
        const target = rand(drawRange.min, drawRange.max);
        if(usedResults.has(target)) continue;

        // definir n operandos + limite de tipos de opera√ß√µes conforme dificuldade
        let n=2, maxOpKinds=1;
        if(configExprDifficulty==='easy'){ n=2; maxOpKinds=1; }
        else if(configExprDifficulty==='normal'){ n=rand(2,5); maxOpKinds=Math.min(3, configOps.length); }
        else { n=rand(5,10); maxOpKinds=Math.min(4, configOps.length); }

        const opsToUse = sample(configOps, Math.max(1, Math.min(maxOpKinds, configOps.length)));

        const node = buildASTForTarget(target, n, opsToUse, {min:1, max:configExprNumberMax}, 220);
        if(!node) continue;

        const rendered = renderExpression(node, { difficulty: configExprDifficulty });
        const plainEval = rendered.plain; // JS-evaluable string
        const display = (configExprDifficulty==='easy') ? `${rendered.display_no_parens} = ?` : `${rendered.display} = ?`;

        const canonical = canonicalizeExpression(rendered.display);
        if(usedExpressions.has(canonical)) continue;

        // garantir que avalia exatamente ao alvo
        let val;
        try{ val = Math.round(Function(`return (${plainEval})`)()); } catch(e){ continue; }
        if(val!==target) continue;

        exprObj = { display, result: target, plain: plainEval, canonical };
        break;
      }

      if(!exprObj){ alert('N√£o foi poss√≠vel gerar uma express√£o √∫nica com as configura√ß√µes atuais. Ajuste as op√ß√µes.'); return; }

      currentExpressionObj = exprObj;
      usedResults.add(exprObj.result);
      usedExpressions.add(exprObj.canonical);
      historyExpressions.unshift({ display: exprObj.display, result: exprObj.result, plain: exprObj.plain, canonical: exprObj.canonical });

      // atualizar UI (resultado oculto)
      document.getElementById('current-expression').textContent = exprObj.display;
      document.getElementById('current-number').textContent = '?';
      renderHistory();

      // marcar internamente nas cartelas (sem revelar visual)
      if(generatedCards.length) markCardsForResult(exprObj.result, false);
    }

    function applyConfigIfNotApplied(){
      // se usu√°rio veio direto ao jogo sem clicar em salvar
      // apenas valida superficialmente os inputs e atualiza vari√°veis
      const dmin=+document.getElementById('draw-min').value||1, dmax=+document.getElementById('draw-max').value||50;
      if(dmin<dmax) drawRange={min:dmin,max:dmax};
      const ops=[];
      if(document.getElementById('op-add').checked) ops.push('+');
      if(document.getElementById('op-sub').checked) ops.push('-');
      if(document.getElementById('op-mul').checked) ops.push('√ó');
      if(document.getElementById('op-div').checked) ops.push('√∑');
      if(ops.length) configOps=ops;
      configExprDifficulty = document.getElementById('expr-difficulty').value || configExprDifficulty;
      configExprNumberMax = +document.getElementById('expr-interval').value || configExprNumberMax;
    }

    // AST Node helpers
    function Num(v){ return {type:'num', value:v}; }
    function Op(op,left,right){ return {type:'op', op,left,right}; }

    function buildASTForTarget(T, n, ops, range, maxTries){
      let tries=0;
      function attempt(T,n){
        tries++; if(tries>maxTries) return null;
        if(n===1){
          if(T>=range.min && T<=range.max) return Num(T);
          return null;
        }
        const opsShuffled = shuffleCopy(ops);
        for(const op of opsShuffled){
          for(let leftCount=1; leftCount<=n-1; leftCount++){
            const rightCount=n-leftCount;

            if(op==='+'){
              for(let k=0;k<10;k++){
                const L=rand(range.min, range.max);
                const R=T-L; if(R<range.min || R>range.max) continue;
                const left=attempt(L,leftCount); if(!left) continue;
                const right=attempt(R,rightCount); if(!right) continue;
                return Op('+', left, right);
              }
            } else if(op==='-'){
              for(let k=0;k<10;k++){
                const R=rand(range.min, range.max);
                const L=T+R; if(L<range.min || L>range.max) continue;
                const left=attempt(L,leftCount); if(!left) continue;
                const right=attempt(R,rightCount); if(!right) continue;
                return Op('-', left, right);
              }
            } else if(op==='√ó'){
              const absT = Math.abs(T);
              if(absT===0){
                // T=0 n√£o costuma ocorrer pois sorteio come√ßa em 1
                continue;
              }
              const divs = getDivisors(absT); shuffle(divs);
              for(const d of divs){
                const L=d, R = T / d;
                if(!Number.isInteger(R)) continue;
                if(L<range.min || L>range.max || R<range.min || R>range.max) continue;
                const left=attempt(L,leftCount); if(!left) continue;
                const right=attempt(R,rightCount); if(!right) continue;
                return Op('√ó', left, right);
              }
            } else if(op==='√∑'){
              for(let k=0;k<12;k++){
                const R=rand(range.min, range.max);
                const L=T*R;
                if(L<range.min || L>range.max) continue;
                const left=attempt(L,leftCount); if(!left) continue;
                const right=attempt(R,rightCount); if(!right) continue;
                return Op('√∑', left, right);
              }
            }
          }
        }
        return null;
      }

      // v√°rias tentativas
      for(let i=0;i<maxTries;i++){
        const node = attempt(T,n);
        if(node) return node;
      }
      return null;
    }

    // Renderiza√ß√£o com par√™nteses m√≠nimos + colchetes ocasionais (hard)
    function renderExpression(node, {difficulty='normal'}={}){
      function precOf(op){ return PREC[op]||3; }

      function toStrings(n){
        if(n.type==='num'){
          const s=String(n.value);
          return { display:s, plain:s, precedence:3 }; // maior prec: nunca precisa par√™nteses
        }
        const left=toStrings(n.left);
        const right=toStrings(n.right);
        const p=precOf(n.op);

        // Quando usar par√™nteses?
        const needParensLeft  = left.precedence  < p;
        let needParensRight = right.precedence < p;
        // casos n√£o comutativos: a - (b ¬± c), a √∑ (b op c)
        if(n.op==='-' || n.op==='√∑'){
          if(right.precedence===p){ needParensRight = true; }
        }

        const leftDisp  = needParensLeft  ? `(${left.display})` : left.display;
        const rightDisp = needParensRight ? `(${right.display})` : right.display;
        const leftPlain  = needParensLeft  ? `(${left.plain})` : left.plain;
        const rightPlain = needParensRight ? `(${right.plain})` : right.plain;

        const sym = n.op, jsop = (sym==='√ó'?'*':(sym==='√∑'?'/':sym));
        return {
          display: `${leftDisp} ${sym} ${rightDisp}`,
          plain:   `${leftPlain} ${jsop} ${rightPlain}`,
          precedence: p
        };
      }

      // strings completas
      let base = toStrings(node);

      // F√°cil: sem par√™nteses (garantimos 2 n√∫meros e 1 opera√ß√£o)
      let display_no_parens = base.display.replaceAll('(', '').replaceAll(')', '');

      // Normal: j√° com par√™nteses m√≠nimos; ocasionalmente remover par√™nteses triviais redundantes extras (j√° s√£o m√≠nimos).
      let display_minimal = base.display;

      // Dif√≠cil: par√™nteses m√≠nimos + chance de substituir alguns por colchetes para dar aspecto de agrupamentos
      if(difficulty==='hard'){
        display_minimal = sprinkleBrackets(display_minimal, 0.35); // 35% dos pares
      }

      return { display: (difficulty==='easy'?display_no_parens:display_minimal), display_no_parens, plain: base.plain };
    }

    function sprinkleBrackets(s, prob){
      // substitui alguns pares de () por [] aleatoriamente
      const stack=[];
      const chars=s.split('');
      for(let i=0;i<chars.length;i++){
        if(chars[i]==='(') stack.push(i);
        else if(chars[i]===')'){
          const j=stack.pop();
          if(j!=null && Math.random()<prob){ chars[j]='['; chars[i]=']'; }
        }
      }
      return chars.join('');
    }

    function canonicalizeExpression(s){
      // vers√£o minificada, sem espa√ßos, par√™nteses normais para padronizar colchetes
      return s.replaceAll('[','(').replaceAll(']',')').replace(/\s+/g,'').trim();
    }

    // ======= Hist√≥rico, verificador, marca√ß√£o =======
    function renderHistory(){
      const list=document.getElementById('history-list'); list.innerHTML='';
      for(const it of historyExpressions){
        const d=document.createElement('div');
        d.style.padding='6px'; d.style.borderBottom='1px dashed rgba(255,255,255,.18)'; d.style.fontWeight='800';
        d.textContent = it.display;
        list.appendChild(d);
      }
    }

    function verifyNumber(){
      const inp=document.getElementById('verify-number');
      const out=document.getElementById('verify-result');
      out.innerHTML='';
      if(!inp.value){ out.textContent='Digite um n√∫mero para verificar.'; return; }
      const n = +inp.value;
      if(usedResults.has(n)){
        const found = historyExpressions.find(h=>h.result===n);
        out.innerHTML=`<div style="color:#86efac;font-weight:900">‚úì N√∫mero sorteado.</div>
                       <div style="margin-top:6px">Express√£o: ${found ? found.display.replace(' = ?',''):'‚Äî'}</div>`;
      }else{
        out.innerHTML=`<div style="color:#fca5a5;font-weight:900">‚úó N√∫mero N√ÉO foi sorteado.</div>`;
      }
    }

    function revealResult(){
      if(!currentExpressionObj){ alert('Nenhuma express√£o atual. Fa√ßa um sorteio.'); return; }
      document.getElementById('current-number').textContent = String(currentExpressionObj.result);
      updateGameCardDOMMarks();
    }

    function resetGame(){
      if(!confirm('Reiniciar o sorteio? (mant√©m as cartelas geradas)')) return;
      historyExpressions=[]; usedResults=new Set(); usedExpressions=new Set();
      currentExpressionObj=null;
      document.getElementById('current-expression').textContent='Nenhuma express√£o sorteada';
      document.getElementById('current-number').textContent='?';
      document.getElementById('history-list').innerHTML='';
      document.getElementById('verify-number').value='';
      document.getElementById('verify-result').innerHTML='';
      if(generatedCards.length){
        window.cardMarks = generatedCards.map(card => card.map(v => v==='FREE'));
        renderGameCards();
      }
      const box=document.getElementById('winner-box');
      box.style.display='none'; box.innerHTML='';
    }

    // ======= Cartelas no jogo =======
    function renderGameCards(){
      const container=document.getElementById('cards-in-game');
      container.innerHTML='';
      cardDomMap=[];
      if(!generatedCards.length){
        container.innerHTML='<div class="muted">Nenhuma cartela carregada (opcional). Voc√™ pode jogar apenas com o sorteio.</div>';
        return;
      }
      if(!window.cardMarks) window.cardMarks = generatedCards.map(card=>card.map(v=>v==='FREE'));
      for(let ci=0;ci<generatedCards.length;ci++){
        const card=generatedCards[ci];
        const cardDiv=document.createElement('div'); cardDiv.className='cartela';
        const title=document.createElement('div'); title.className='cartela-title'; title.textContent=`Cartela ${ci+1}`;
        cardDiv.appendChild(title);
        const grid=document.createElement('div');
        grid.style.display='grid'; grid.style.gridTemplateColumns=`repeat(${generatedCardSize},1fr)`; grid.style.gap='6px';
        const marks=window.cardMarks[ci];
        const cellEls=[];
        for(let idx=0;idx<card.length;idx++){
          const val=card[idx];
          const c=document.createElement('div'); c.className='cell';
          c.textContent=(val==='FREE'?'FREE':String(val));
          if(marks[idx]) c.classList.add('marked');
          c.addEventListener('click', ()=>{ // altern√¢ncia manual
            marks[idx]=!marks[idx];
            c.classList.toggle('marked', marks[idx]);
            checkBingoForCard(ci);
          });
          grid.appendChild(c); cellEls.push(c);
        }
        cardDiv.appendChild(grid);
        const bingoNote=document.createElement('div'); bingoNote.style.marginTop='8px'; bingoNote.style.fontWeight='900'; bingoNote.style.color='#86efac';
        bingoNote.textContent='';
        cardDiv.appendChild(bingoNote);

        container.appendChild(cardDiv);
        cardDomMap.push({cellEls, bingoNote});
        checkBingoForCard(ci);
      }
    }

    function markCardsForResult(n, autoReveal){
      if(!generatedCards.length) return;
      if(!window.cardMarks) window.cardMarks = generatedCards.map(card=>card.map(v=>v==='FREE'));
      for(let ci=0;ci<generatedCards.length;ci++){
        const card=generatedCards[ci], marks=window.cardMarks[ci];
        for(let i=0;i<card.length;i++) if(card[i]!=='FREE' && +card[i]===+n) marks[i]=true;
      }
      if(autoReveal) updateGameCardDOMMarks();
    }
    function updateGameCardDOMMarks(){
      if(!generatedCards.length) return;
      for(let ci=0;ci<generatedCards.length;ci++){
        const marks=window.cardMarks[ci], dom=cardDomMap[ci]; if(!dom) continue;
        for(let i=0;i<dom.cellEls.length;i++) dom.cellEls[i].classList.toggle('marked', !!marks[i]);
        checkBingoForCard(ci);
      }
    }
    function checkBingoForCard(ci){
      if(!generatedCards.length) return false;
      const marks=window.cardMarks[ci], size=generatedCardSize;
      let bingo=false;
      // rows
      for(let r=0;r<size;r++){
        let ok=true; for(let c=0;c<size;c++){ if(!marks[r*size+c]){ok=false;break;} }
        if(ok) bingo=true;
      }
      // cols
      for(let c=0;c<size;c++){
        let ok=true; for(let r=0;r<size;r++){ if(!marks[r*size+c]){ok=false;break;} }
        if(ok) bingo=true;
      }
      // diagonais
      let ok=true; for(let i=0;i<size;i++) if(!marks[i*size+i]) {ok=false;break;}
      if(ok) bingo=true;
      ok=true; for(let i=0;i<size;i++) if(!marks[i*size+(size-1-i)]) {ok=false;break;}
      if(ok) bingo=true;

      const dom=cardDomMap[ci];
      if(dom){
        if(bingo){
          dom.bingoNote.textContent='BINGO!';
          showWinner(ci);
        }else dom.bingoNote.textContent='';
      }
      return bingo;
    }
    function showWinner(ci){
      const box=document.getElementById('winner-box');
      box.style.display='block';
      box.innerHTML=`<strong>Cartela ${ci+1} fez BINGO!</strong><div style="margin-top:6px">Parab√©ns! Voc√™ pode encerrar a rodada ou continuar.</div>`;
    }

    // ======= Utilit√°rios =======
    function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function shuffleCopy(a){ const c=a.slice(); return shuffle(c); }
    function sample(arr,n){ if(n>=arr.length) return arr.slice(); const c=arr.slice(); shuffle(c); return c.slice(0,n); }
    function getDivisors(n){ n=Math.abs(Math.floor(n)); const out=[]; if(n<=0) return out; for(let i=1;i<=n;i++) if(n%i===0) out.push(i); return out; }

    // ======= Inicializa√ß√£o =======
    function refreshFreeOption(){ /* redefinida acima */ }
    function updatePreview(){ /* redefinida acima */ }
    // chamada inicial
    (function(){
      refreshFreeOption();
      updatePreview();
    })();
  </script>
</body>
</html>
