<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bingo Matemático — Teste</title>

  <!-- jsPDF (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* --- Estilos simplificados e responsivos --- */
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(135deg,#e6f0ff,#f8fbff);min-height:100vh;margin:0;padding:20px;display:flex;flex-direction:column;align-items:center}
    .container{width:100%;max-width:1100px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(30,50,100,0.08);overflow:hidden}
    header{background:#2e7be6;color:#fff;padding:18px 24px}
    header h1{margin:0;font-size:1.4rem}
    .content{padding:20px}
    .screen{display:none}
    .screen.active{display:block}
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type=number],select{width:100%;padding:10px;border:1px solid #d6e4ff;border-radius:8px}
    input[type=checkbox]{transform:scale(1.05);margin-right:8px}
    .btn{display:inline-block;padding:10px 18px;border-radius:999px;border:none;background:#2e7be6;color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#2dbb89}
    .btn.ghost{background:transparent;border:1px solid #ddd;color:#333}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .warn{background:#fff3f3;color:#802020;padding:10px;border-radius:8px;border:1px solid #f3c6c6;display:none;margin-top:8px}
    .ok{background:#f0fff6;color:#0b6620;padding:10px;border-radius:8px;border:1px solid #b9f0cf;display:none;margin-top:8px}
    .card-preview{margin-top:12px;display:grid;gap:6px}
    .cell{background:#f7fbff;border:1px solid #e3efff;padding:10px;text-align:center;border-radius:6px;font-weight:700;min-height:48px;display:flex;align-items:center;justify-content:center}
    .cell.free{background:#2e7be6;color:#fff}
    .grid-wrapper{max-width:560px;margin-top:12px}
    .pdf-preview{margin-top:18px;padding:12px;border-radius:8px;border:1px dashed #cfe1ff;background:#fbfdff}
    .pdf-card{padding:8px;border:1px solid #e6f2ff;border-radius:6px;background:#fff}
    footer{margin-top:18px;font-size:.9rem;color:#555;text-align:center;padding:8px}
    @media (max-width:900px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Bingo Matemático — Protótipo</h1>
    </header>

    <div class="content">
      <!-- HOME -->
      <div id="home" class="screen active">
        <h2>Bem-vindo</h2>
        <p>Use as opções abaixo para gerar cartelas ou iniciar um sorteio.</p>
        <div class="controls" style="margin-top:12px">
          <button class="btn" data-target="generate">Gerar Cartelas</button>
          <button class="btn secondary" data-target="config">Configurar Sorteio</button>
          <button class="btn ghost" data-target="help">Ajuda / Testes</button>
        </div>
      </div>

      <!-- GERAÇÃO DE CARTELAS -->
      <div id="generate" class="screen">
        <h2>Gerar Cartelas</h2>

        <div class="row">
          <div class="col">
            <label for="min-number">Número mínimo</label>
            <input id="min-number" type="number" value="1" min="0">
          </div>
          <div class="col">
            <label for="max-number">Número máximo</label>
            <input id="max-number" type="number" value="50" min="1">
          </div>
          <div class="col">
            <label for="grid-size">Tamanho da cartela (N × N)</label>
            <select id="grid-size">
              <!-- 3 até 9 -->
              <option value="3">3 × 3</option>
              <option value="4">4 × 4</option>
              <option value="5" selected>5 × 5</option>
              <option value="6">6 × 6</option>
              <option value="7">7 × 7</option>
              <option value="8">8 × 8</option>
              <option value="9">9 × 9</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px;align-items:center">
          <div class="col">
            <label for="card-count">Quantidade de cartelas</label>
            <input id="card-count" type="number" value="4" min="1" max="200">
          </div>
          <div style="min-width:200px;display:flex;flex-direction:column;gap:6px">
            <label><input id="free-center" type="checkbox" checked> Incluir FREE no centro (apenas se N ímpar)</label>
            <label><input id="allow-repeats" type="checkbox"> Permitir repetições se intervalo insuficiente</label>
          </div>
        </div>

        <div id="validation" class="warn"></div>
        <div id="validation-ok" class="ok"></div>

        <div class="grid-wrapper">
          <h3>Pré-visualização</h3>
          <div id="card-preview" class="card-preview"></div>
        </div>

        <div style="margin-top:14px" class="controls">
          <button id="btn-generate" class="btn">Gerar Cartelas</button>
          <button class="btn ghost" data-target="home">Voltar</button>
        </div>

        <div id="generated-area" style="display:none;margin-top:14px">
          <h3>Pré-visualização do PDF</h3>
          <div class="pdf-preview" id="pdf-preview"></div>
          <div style="margin-top:10px" class="controls">
            <button id="btn-pdf" class="btn">Gerar PDF para impressão</button>
            <button class="btn ghost" onclick="document.getElementById('generated-area').style.display='none'">Fechar pré-visualização</button>
          </div>
        </div>
      </div>

      <!-- CONFIGURAÇÃO SORTEIO (simples, reaproveita valores) -->
      <div id="config" class="screen">
        <h2>Configurar Sorteio</h2>
        <p>Escolha as operações, intervalo dos resultados e dificuldades (estes valores influenciam as expressões sorteadas).</p>

        <div class="row" style="margin-top:8px">
          <div style="min-width:200px">
            <label>Operações</label>
            <div>
              <label><input id="op-add" type="checkbox" checked> +</label>
              <label style="margin-left:8px"><input id="op-sub" type="checkbox" checked> -</label>
              <label style="margin-left:8px"><input id="op-mul" type="checkbox"> ×</label>
              <label style="margin-left:8px"><input id="op-div" type="checkbox"> ÷</label>
            </div>
          </div>
          <div class="col">
            <label for="res-min">Resultado mínimo</label>
            <input id="res-min" type="number" value="1" min="0">
          </div>
          <div class="col">
            <label for="res-max">Resultado máximo</label>
            <input id="res-max" type="number" value="50" min="1">
          </div>
        </div>

        <div style="margin-top:12px" class="controls">
          <button class="btn" onclick="startGame()">Iniciar Jogo</button>
          <button class="btn ghost" data-target="home">Voltar</button>
        </div>
      </div>

      <!-- AJUDA / TESTES -->
      <div id="help" class="screen">
        <h2>Ajuda rápida / Testes</h2>
        <ul>
          <li>Para testar rapidamente: altere o tamanho para 3×3 (dá menos restrição) e gere cartelas.</li>
          <li>Se não conseguir gerar por causa do intervalo, marque "Permitir repetições" ou aumente o intervalo.</li>
        </ul>
        <div style="margin-top:12px" class="controls">
          <button class="btn ghost" data-target="home">Voltar</button>
        </div>
      </div>
    </div>
  </div>

  <footer>Gerado automaticamente — Salve o arquivo e execute localmente para testar.</footer>

  <script>
    // --- Estado global ---
    let generatedCards = [];
    let drawnExpressions = [];
    let drawnResults = new Set();

    // Navegação robusta: botões com data-target
    document.querySelectorAll('[data-target]').forEach(btn=>{
      btn.addEventListener('click', ()=> showScreen(btn.getAttribute('data-target')));
    });

    function showScreen(id){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      const el = document.getElementById(id);
      if (el) el.classList.add('active');
      // atualização de preview sempre que entrar na tela de geração
      if (id === 'generate') updatePreview();
    }

    // Elementos
    const minInput = document.getElementById('min-number');
    const maxInput = document.getElementById('max-number');
    const sizeSelect = document.getElementById('grid-size');
    const freeCheckbox = document.getElementById('free-center');
    const repeatsCheckbox = document.getElementById('allow-repeats');
    const previewContainer = document.getElementById('card-preview');
    const validationEl = document.getElementById('validation');
    const validationOkEl = document.getElementById('validation-ok');
    const btnGenerate = document.getElementById('btn-generate');
    const generatedArea = document.getElementById('generated-area');
    const pdfPreview = document.getElementById('pdf-preview');
    const btnPdf = document.getElementById('btn-pdf');

    // Atualizar comportamento FREE se tamanho for par
    function refreshFreeOption(){
      const size = parseInt(sizeSelect.value,10);
      if (size % 2 === 0){
        freeCheckbox.checked = false;
        freeCheckbox.disabled = true;
        freeCheckbox.parentElement.style.opacity = 0.6;
      } else {
        freeCheckbox.disabled = false;
        freeCheckbox.parentElement.style.opacity = 1;
      }
    }

    sizeSelect.addEventListener('change', ()=>{
      refreshFreeOption();
      updatePreview();
    });

    [minInput,maxInput,freeCheckbox,repeatsCheckbox].forEach(el=>{
      el.addEventListener('input', updatePreview);
      el.addEventListener('change', updatePreview);
    });

    // Validação: quantidade necessária de números únicos
    function requiredNumbers(size, freeCenter){
      return size*size - (freeCenter ? 1 : 0);
    }
    function availablePool(min,max){
      return Math.max(0, max - min + 1);
    }
    function hasEnoughUnique(min,max,size,freeCenter){
      return availablePool(min,max) >= requiredNumbers(size,freeCenter);
    }

    // Atualiza preview: constrói grid NxN e preenche com números (ou mensagens)
    function updatePreview(){
      validationEl.style.display = 'none'; validationOkEl.style.display = 'none';
      previewContainer.innerHTML = '';
      const min = parseInt(minInput.value,10) || 1;
      const max = parseInt(maxInput.value,10) || 1;
      const size = parseInt(sizeSelect.value,10);
      const free = !!freeCheckbox.checked;
      const allowRepeats = !!repeatsCheckbox.checked;

      refreshFreeOption(); // ajusta free checkbox se necessário

      // checagens básicas
      if (min >= max){
        validationEl.textContent = 'Erro: o valor mínimo deve ser menor que o valor máximo.';
        validationEl.style.display = 'block';
        btnGenerate.disabled = true;
        return;
      }
      const pool = availablePool(min,max);
      const req = requiredNumbers(size, free);

      if (pool < req && !allowRepeats){
        validationEl.innerHTML = `Intervalo insuficiente: precisa de ${req} números distintos, mas o intervalo tem ${pool}.<br>Marque "Permitir repetições" para prosseguir com números repetidos, ou aumente o intervalo.`;
        validationEl.style.display = 'block';
        btnGenerate.disabled = true;
        return;
      }

      // ok
      validationOkEl.textContent = `Intervalo aceitável. Cartela ${size}×${size}, ${free ? 'com' : 'sem'} FREE, ${allowRepeats ? 'permite' : 'não permite'} repetições.`;
      validationOkEl.style.display = 'block';
      btnGenerate.disabled = false;

      // CSS grid dinamicamente
      previewContainer.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
      // criar uma cartela de pré-visualização
      const card = safeGenerateBingoCard(min,max,size,free,allowRepeats);
      for (let i=0;i<size*size;i++){
        const div = document.createElement('div');
        div.className = 'cell';
        const val = card[i];
        if (val === 'FREE'){ div.classList.add('free'); div.textContent = 'FREE'; }
        else div.textContent = String(val);
        previewContainer.appendChild(div);
      }
    }

    // Geração segura: permite repetições se allowRepeats true; caso contrário exige pool >= req
    function safeGenerateBingoCard(min,max,size,freeCenter,allowRepeats){
      const totalCells = size*size;
      const needed = totalCells - (freeCenter ? 1 : 0);
      const pool = availablePool(min,max);
      if (!allowRepeats && pool < needed){
        throw new Error('Pool insuficiente e repetições não permitidas');
      }

      const out = [];
      const numbers = [];
      if (allowRepeats){
        // preenche permitindo repetições
        while (numbers.length < needed){
          numbers.push(getRandomNumber(min,max));
        }
      } else {
        // sem repetições: sortear conjunto único
        const set = new Set();
        while (set.size < needed){
          set.add(getRandomNumber(min,max));
        }
        numbers.push(...Array.from(set));
      }
      // embaralha
      shuffleArray(numbers);
      // montar saída NxN com FREE se aplicável (posicao central)
      let idx = 0;
      for (let r=0;r<size;r++){
        for (let c=0;c<size;c++){
          const pos = r*size + c;
          if (freeCenter && size%2===1 && r===Math.floor(size/2) && c===Math.floor(size/2)){
            out[pos] = 'FREE';
          } else {
            out[pos] = numbers[idx++];
          }
        }
      }
      return out;
    }

    // Gera N cartelas e mostra preview PDF
    btnGenerate.addEventListener('click', ()=>{
      const min = parseInt(minInput.value,10) || 1;
      const max = parseInt(maxInput.value,10) || 1;
      const size = parseInt(sizeSelect.value,10);
      const free = !!freeCheckbox.checked;
      const count = parseInt(document.getElementById('card-count').value,10) || 1;
      const allowRepeats = !!repeatsCheckbox.checked;

      // valida novamente
      const pool = availablePool(min,max);
      const req = requiredNumbers(size, free);
      if (min >= max){ alert('Mínimo deve ser menor que máximo.'); return; }
      if (!allowRepeats && pool < req){ alert(`Intervalo insuficiente: precisa de ${req} números distintos.`); return; }

      generatedCards = [];
      for (let i=0;i<count;i++){
        generatedCards.push(safeGenerateBingoCard(min,max,size,free,allowRepeats));
      }
      renderPDFPreview(generatedCards, size);
      generatedArea.style.display = 'block';
      // rolar para visualização
      generatedArea.scrollIntoView({behavior:'smooth'});
    });

    // Renderiza uma prévia simples no HTML (até 4 cartelas)
    function renderPDFPreview(cards,size){
      pdfPreview.innerHTML = '';
      const toShow = Math.min(cards.length, 4);
      const wrapper = document.createElement('div');
      wrapper.style.display = 'grid';
      wrapper.style.gridTemplateColumns = 'repeat(2,1fr)';
      wrapper.style.gap = '10px';
      for (let k=0;k<toShow;k++){
        const card = cards[k];
        const el = document.createElement('div');
        el.className = 'pdf-card';
        const title = document.createElement('div'); title.style.fontWeight = 800; title.style.color = '#2e7be6';
        title.textContent = `Cartela ${k+1}`;
        el.appendChild(title);
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
        grid.style.gap = '4px';
        grid.style.marginTop = '8px';
        for (let i=0;i<size*size;i++){
          const cell = document.createElement('div');
          cell.style.border = '1px solid #e9f3ff';
          cell.style.padding = '6px';
          cell.style.textAlign = 'center';
          cell.style.fontWeight = '700';
          cell.style.minHeight = '26px';
          if (card[i] === 'FREE'){ cell.style.background = '#2e7be6'; cell.style.color = '#fff'; cell.textContent = 'FREE'; }
          else cell.textContent = String(card[i]);
          grid.appendChild(cell);
        }
        el.appendChild(grid);
        wrapper.appendChild(el);
      }
      pdfPreview.appendChild(wrapper);
      if (cards.length > 4){
        const more = document.createElement('div'); more.style.marginTop='8px'; more.style.textAlign='center';
        more.textContent = `... e mais ${cards.length - 4} cartelas`;
        pdfPreview.appendChild(more);
      }
    }

    // Gerar PDF com jsPDF
    btnPdf.addEventListener('click', ()=>{
      if (!generatedCards || !generatedCards.length){ alert('Nenhuma cartela gerada.'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt',format:'a4'});
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 36;
      // Vamos colocar 2 colunas × 2 linhas por página (4 cartelas por página)
      const cardW = (pageW - margin*3) / 2;
      const cardH = (pageH - margin*3) / 2;
      let x = margin, y = margin;
      for (let i=0;i<generatedCards.length;i++){
        if (i>0 && i%4===0){ doc.addPage(); x = margin; y = margin; }
        drawCardToPDF(doc, generatedCards[i], x, y, cardW, cardH, parseInt(sizeSelect.value,10), i+1);
        // desloca para próxima posição
        if ((i%4)%2 === 0) x += cardW + margin; else { x = margin; y += cardH + margin; }
      }
      doc.save('cartelas-bingo.pdf');
    });

    function drawCardToPDF(doc, card, x, y, w, h, size, cardNum){
      const cw = w / size;
      const ch = h / size;
      doc.setDrawColor(60,110,200);
      doc.rect(x,y,w,h);
      for (let r=0;r<size;r++){
        for (let c=0;c<size;c++){
          const cx = x + c*cw, cy = y + r*ch;
          doc.rect(cx, cy, cw, ch);
          const idx = r*size + c;
          const val = card[idx];
          if (val === 'FREE'){
            doc.setFillColor(46,123,230);
            doc.rect(cx, cy, cw, ch, 'F');
            doc.setTextColor(255,255,255);
          } else {
            doc.setTextColor(0,0,0);
          }
          // Texto centralizado
          const text = String(val);
          doc.setFontSize(Math.max(8, Math.min(20, cw/4)));
          doc.text(text, cx + cw/2, cy + ch/2, {align:'center',baseline:'middle'});
        }
      }
      doc.setFontSize(10);
      doc.setTextColor(60,110,200);
      doc.text(`Cartela ${cardNum}`, x + w/2, y + h + 12, {align:'center', baseline:'top'});
    }

    // Auxiliares
    function getRandomNumber(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function shuffleArray(a){ for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

    // Inicializa preview
    refreshFreeOption();
    updatePreview();

    // --- SORTEIO (simples) ---
    function startGame(){
      // verifica ao menos uma operação selecionada
      const ops = [];
      if (document.getElementById('op-add').checked) ops.push('+');
      if (document.getElementById('op-sub').checked) ops.push('-');
      if (document.getElementById('op-mul').checked) ops.push('×');
      if (document.getElementById('op-div').checked) ops.push('÷');
      if (ops.length === 0){ alert('Selecione ao menos uma operação.'); return; }

      const rmin = parseInt(document.getElementById('res-min').value,10) || 1;
      const rmax = parseInt(document.getElementById('res-max').value,10) || 50;
      if (rmin >= rmax){ alert('Resultado mínimo deve ser menor que máximo.'); return; }

      // Redireciona para tela de jogo (não implementado completo — apenas placeholder)
      alert('Função iniciar jogo (protótipo): em produção, aqui inicializaríamos o sorteio com as operações e intervalos selecionados.');
      // se quiser, podemos integrar com as cartelas geradas para jogo real — me diga que eu implemento.
    }

  </script>
</body>
</html>
